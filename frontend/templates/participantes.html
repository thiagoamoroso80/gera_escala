{% extends "base.html" %}

{% block content %}
<div class="container-fluid px-0">
    <!-- Cabeçalho -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 px-3 px-md-4">
        <div class="mb-3 mb-md-0">
            <h1 class="h3 mb-1"><i class="bi bi-people me-2"></i>Participantes</h1>
            <p class="text-muted mb-0">Gerencie os participantes do sistema</p>
        </div>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalAdicionar">
            <i class="bi bi-person-plus me-1"></i> <span class="d-none d-sm-inline">Novo</span> Participante
        </button>
    </div>

    <!-- Notificações -->
    <div id="notificacao" class="alert alert-success alert-dismissible fade mx-3 mx-md-4" role="alert" style="display: none;">
        <span id="notificacaoTexto"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div class="card border-0 shadow-sm mx-3 mx-md-4 mb-4">
        <div class="card-body p-0">
            {% if participantes %}
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="tabelaParticipantes">
                    <thead class="table-light">
                        <tr>
                            <th class="border-0 ps-4">ID</th>
                            <th class="border-0">Nome</th>
                            <th class="border-0 d-none d-lg-table-cell">Telefone</th>
                            <th class="border-0 d-none d-md-table-cell">Email</th>
                            <th class="border-0">Instituição</th>
                            <th class="border-0 d-none d-xl-table-cell">Grupo Lar</th>
                            <th class="border-0 d-none d-xl-table-cell">Grupo Tenda</th>
                            <th class="border-0">Status</th>
                            <th class="border-0 pe-4 text-end">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="corpoTabela">
                        {% for p in participantes %}
                        <tr id="participante-{{ p.id }}" class="align-middle">
                            <td class="ps-4 fw-semibold">{{ p.id }}</td>
                            <td>
                                <div class="d-flex flex-column">
                                    <span class="fw-medium">{{ p.nome }}</span>
                                    <div class="d-flex d-lg-none mt-1">
                                        <small class="text-muted me-3">
                                            <i class="bi bi-telephone me-1"></i>{{ p.telefone or 'Não informado' }}
                                        </small>
                                    </div>
                                </div>
                            </td>
                            <td class="d-none d-lg-table-cell">
                                {% if p.telefone %}
                                <i class="bi bi-telephone me-1"></i>{{ p.telefone }}
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="d-none d-md-table-cell">
                                {% if p.email %}
                                <i class="bi bi-envelope me-1"></i>
                                <span class="text-truncate d-inline-block" style="max-width: 180px;">{{ p.email }}</span>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if p.instituicao == 'lar' %}
                                <span class="badge bg-success-subtle text-success border border-success-subtle">
                                    <i class="bi bi-house me-1"></i>Lar
                                </span>
                                {% elif p.instituicao == 'tenda' %}
                                <span class="badge bg-primary-subtle text-primary border border-primary-subtle">
                                    <i class="bi bi-building me-1"></i>Tenda
                                </span>
                                {% else %}
                                <span class="badge bg-info-subtle text-info border border-info-subtle">
                                    <i class="bi bi-buildings me-1"></i>Ambas
                                </span>
                                {% endif %}
                            </td>
                            <td class="d-none d-xl-table-cell">
                                {% if p.grupo_lar %}
                                    {% for grupo in grupos_lar %}
                                        {% if grupo.id|string == p.grupo_lar %}
                                        <span class="badge bg-secondary-subtle text-secondary">
                                            {{ grupo.nome }}
                                        </span>
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="d-none d-xl-table-cell">
                                {% if p.grupo_tenda %}
                                    {% for grupo in grupos_tenda %}
                                        {% if grupo.id|string == p.grupo_tenda %}
                                        <span class="badge bg-secondary-subtle text-secondary">
                                            {{ grupo.nome }}
                                        </span>
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if p.ativo %}
                                <span class="badge bg-success-subtle text-success border border-success-subtle">
                                    <i class="bi bi-check-circle me-1"></i>Ativo
                                </span>
                                {% else %}
                                <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle">
                                    <i class="bi bi-x-circle me-1"></i>Inativo
                                </span>
                                {% endif %}
                            </td>
                            <td class="pe-4">
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="btn btn-outline-warning btn-editar" data-id="{{ p.id }}" 
                                            title="Editar participante">
                                        <i class="bi bi-pencil"></i>
                                        <span class="d-none d-sm-inline ms-1">Editar</span>
                                    </button>
                                    <button class="btn btn-outline-danger btn-excluir" data-id="{{ p.id }}"
                                            title="Excluir participante">
                                        <i class="bi bi-trash"></i>
                                        <span class="d-none d-sm-inline ms-1">Excluir</span>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Informação de resultados -->
            <div class="px-4 py-3 border-top">
                <small class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    {{ participantes|length }} participante{{ 's' if participantes|length != 1 else '' }} encontrado{{ 's' if participantes|length != 1 else '' }}
                </small>
            </div>
            
            {% else %}
            <!-- Estado vazio -->
            <div class="text-center py-5" id="semParticipantes">
                <div class="mb-4">
                    <i class="bi bi-people text-muted opacity-25" style="font-size: 4rem;"></i>
                </div>
                <h4 class="mb-2">Nenhum participante cadastrado</h4>
                <p class="text-muted mb-4">Adicione o primeiro participante para começar</p>
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalAdicionar">
                    <i class="bi bi-person-plus me-1"></i> Adicionar Participante
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal Adicionar -->
<div class="modal fade" id="modalAdicionar" tabindex="-1" aria-labelledby="modalAdicionarLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title" id="modalAdicionarLabel">
                    <i class="bi bi-person-plus me-2"></i>Adicionar Participante
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <form id="formAdicionar" method="post">
                <input type="hidden" name="username" value="admin">
                <input type="hidden" name="password" value="{{ request.query_params.get('password', '') }}">
                
                <div class="modal-body pt-0">
                    <div class="mb-3">
                        <label class="form-label fw-medium">Nome <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="nome" name="nome" required
                               placeholder="Digite o nome completo">
                    </div>
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-medium">Telefone</label>
                            <input type="tel" class="form-control" id="telefone" name="telefone"
                                   placeholder="(00) 00000-0000">
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-medium">Email</label>
                            <input type="email" class="form-control" id="email" name="email"
                                   placeholder="exemplo@email.com">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-medium">Instituição <span class="text-danger">*</span></label>
                        <select class="form-select" id="instituicao" name="instituicao" required>
                            <option value="lar">Lar Otoniel</option>
                            <option value="tenda">Tenda Pai Oxalá</option>
                            <option value="ambos">Ambas as instituições</option>
                        </select>
                    </div>
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-medium">Grupo Lar <small class="text-muted">(opcional)</small></label>
                            <select class="form-select" id="grupo_lar" name="grupo_lar">
                                <option value="">Sem grupo</option>
                                {% for grupo in grupos_lar %}
                                <option value="{{ grupo.id }}">{{ grupo.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-medium">Grupo Tenda <small class="text-muted">(opcional)</small></label>
                            <select class="form-select" id="grupo_tenda" name="grupo_tenda">
                                <option value="">Sem grupo</option>
                                {% for grupo in grupos_tenda %}
                                <option value="{{ grupo.id }}">{{ grupo.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-success" id="btnSalvar">
                        <span class="spinner-border spinner-border-sm me-1" id="spinnerSalvar" style="display: none;"></span>
                        Salvar Participante
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Editar -->
<div class="modal fade" id="modalEditar" tabindex="-1" aria-labelledby="modalEditarLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title" id="modalEditarLabel">
                    <i class="bi bi-pencil me-2"></i>Editar Participante
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <form id="formEditar" method="post">
                <input type="hidden" name="username" value="admin">
                <input type="hidden" name="password" value="{{ request.query_params.get('password', '') }}">
                <input type="hidden" id="editId" name="id">
                
                <div class="modal-body pt-0">
                    <div class="mb-3">
                        <label class="form-label fw-medium">Nome <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editNome" name="nome" required>
                    </div>
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-medium">Telefone</label>
                            <input type="tel" class="form-control" id="editTelefone" name="telefone">
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-medium">Email</label>
                            <input type="email" class="form-control" id="editEmail" name="email">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-medium">Instituição <span class="text-danger">*</span></label>
                        <select class="form-select" id="editInstituicao" name="instituicao" required>
                            <option value="lar">Lar Otoniel</option>
                            <option value="tenda">Tenda Pai Oxalá</option>
                            <option value="ambos">Ambas as instituições</option>
                        </select>
                    </div>
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-medium">Grupo Lar <small class="text-muted">(opcional)</small></label>
                            <select class="form-select" id="editGrupoLar" name="grupo_lar">
                                <option value="">Sem grupo</option>
                                {% for grupo in grupos_lar %}
                                <option value="{{ grupo.id }}">{{ grupo.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-medium">Grupo Tenda <small class="text-muted">(opcional)</small></label>
                            <select class="form-select" id="editGrupoTenda" name="grupo_tenda">
                                <option value="">Sem grupo</option>
                                {% for grupo in grupos_tenda %}
                                <option value="{{ grupo.id }}">{{ grupo.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-medium">Status</label>
                        <select class="form-select" id="editAtivo" name="ativo">
                            <option value="1">Ativo</option>
                            <option value="0">Inativo</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-warning" id="btnAtualizar">
                        <span class="spinner-border spinner-border-sm me-1" id="spinnerAtualizar" style="display: none;"></span>
                        Atualizar Participante
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Função para mostrar notificação
function mostrarNotificacao(mensagem, tipo = 'success') {
    const notificacao = document.getElementById('notificacao');
    const notificacaoTexto = document.getElementById('notificacaoTexto');
    
    notificacao.className = `alert alert-${tipo} alert-dismissible fade show mx-3 mx-md-4`;
    notificacaoTexto.textContent = mensagem;
    notificacao.style.display = 'block';
    
    // Auto-fechar após 5 segundos
    setTimeout(() => {
        const bsAlert = new bootstrap.Alert(notificacao);
        bsAlert.close();
    }, 5000);
}

// Função para adicionar linha na tabela (para adições via AJAX)
function adicionarLinhaTabela(participante) {
    const corpoTabela = document.getElementById('corpoTabela');
    const semParticipantes = document.getElementById('semParticipantes');
    
    // Remover mensagem "sem participantes" se existir
    if (semParticipantes) {
        semParticipantes.remove();
    }
    
    // Determinar instituição
    let instituicaoBadge = '';
    switch(participante.instituicao) {
        case 'lar':
            instituicaoBadge = '<span class="badge bg-success-subtle text-success border border-success-subtle"><i class="bi bi-house me-1"></i>Lar</span>';
            break;
        case 'tenda':
            instituicaoBadge = '<span class="badge bg-primary-subtle text-primary border border-primary-subtle"><i class="bi bi-building me-1"></i>Tenda</span>';
            break;
        default:
            instituicaoBadge = '<span class="badge bg-info-subtle text-info border border-info-subtle"><i class="bi bi-buildings me-1"></i>Ambas</span>';
    }
    
    // Status
    const statusBadge = participante.ativo ? 
        '<span class="badge bg-success-subtle text-success border border-success-subtle"><i class="bi bi-check-circle me-1"></i>Ativo</span>' : 
        '<span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle"><i class="bi bi-x-circle me-1"></i>Inativo</span>';
    
    // Nova linha otimizada para responsividade
    const novaLinha = `
    <tr id="participante-${participante.id}" class="align-middle">
        <td class="ps-4 fw-semibold">${participante.id}</td>
        <td>
            <div class="d-flex flex-column">
                <span class="fw-medium">${participante.nome}</span>
                <div class="d-flex d-lg-none mt-1">
                    <small class="text-muted me-3">
                        <i class="bi bi-telephone me-1"></i>${participante.telefone || 'Não informado'}
                    </small>
                </div>
            </div>
        </td>
        <td class="d-none d-lg-table-cell">
            ${participante.telefone ? `<i class="bi bi-telephone me-1"></i>${participante.telefone}` : '<span class="text-muted">-</span>'}
        </td>
        <td class="d-none d-md-table-cell">
            ${participante.email ? `<i class="bi bi-envelope me-1"></i><span class="text-truncate d-inline-block" style="max-width: 180px;">${participante.email}</span>` : '<span class="text-muted">-</span>'}
        </td>
        <td>${instituicaoBadge}</td>
        <td class="d-none d-xl-table-cell">
            ${participante.grupo_lar ? `<span class="badge bg-secondary-subtle text-secondary">Grupo ${participante.grupo_lar}</span>` : '<span class="text-muted">-</span>'}
        </td>
        <td class="d-none d-xl-table-cell">
            ${participante.grupo_tenda ? `<span class="badge bg-secondary-subtle text-secondary">Grupo ${participante.grupo_tenda}</span>` : '<span class="text-muted">-</span>'}
        </td>
        <td>${statusBadge}</td>
        <td class="pe-4">
            <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-outline-warning btn-editar" data-id="${participante.id}" 
                        title="Editar participante">
                    <i class="bi bi-pencil"></i>
                    <span class="d-none d-sm-inline ms-1">Editar</span>
                </button>
                <button class="btn btn-outline-danger btn-excluir" data-id="${participante.id}"
                        title="Excluir participante">
                    <i class="bi bi-trash"></i>
                    <span class="d-none d-sm-inline ms-1">Excluir</span>
                </button>
            </div>
        </td>
    </tr>`;
    
    // Adicionar no início da tabela
    corpoTabela.insertAdjacentHTML('afterbegin', novaLinha);
    
    // Reatribuir eventos aos novos botões
    reatribuirEventosBotoes();
}

// Função para reatribuir eventos aos botões
function reatribuirEventosBotoes() {
    document.querySelectorAll('.btn-editar').forEach(btn => {
        if (!btn.hasAttribute('data-event-bound')) {
            btn.setAttribute('data-event-bound', 'true');
            btn.addEventListener('click', abrirModalEdicao);
        }
    });
    
    document.querySelectorAll('.btn-excluir').forEach(btn => {
        if (!btn.hasAttribute('data-event-bound')) {
            btn.setAttribute('data-event-bound', 'true');
            btn.addEventListener('click', confirmarExclusao);
        }
    });
}

// Função para abrir modal de edição
async function abrirModalEdicao() {
    const id = this.getAttribute('data-id');
    
    try {
        // Carregar dados via API
        const response = await fetch(`/api/participantes/${id}`);
        const participante = await response.json();
        
        // Preencher formulário
        document.getElementById('editId').value = participante.id;
        document.getElementById('editNome').value = participante.nome || '';
        document.getElementById('editTelefone').value = participante.telefone || '';
        document.getElementById('editEmail').value = participante.email || '';
        document.getElementById('editInstituicao').value = participante.instituicao || 'lar';
        document.getElementById('editGrupoLar').value = participante.grupo_lar || '';
        document.getElementById('editGrupoTenda').value = participante.grupo_tenda || '';
        document.getElementById('editAtivo').value = participante.ativo ? '1' : '0';
        
        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('modalEditar'));
        modal.show();
        
    } catch (error) {
        mostrarNotificacao('Erro ao carregar dados do participante', 'danger');
    }
}

// Função para confirmar exclusão
function confirmarExclusao() {
    const id = this.getAttribute('data-id');
    const nome = this.closest('tr').querySelector('td:nth-child(2) .fw-medium').textContent;
    
    if (confirm(`Tem certeza que deseja excluir o participante "${nome}"?`)) {
        excluirParticipante(id);
    }
}

// Função para excluir via AJAX
async function excluirParticipante(id) {
    try {
        const response = await fetch(`/api/participantes/excluir/${id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                username: 'admin',
                password: '{{ request.query_params.get("password", "") }}'
            })
        });
        
        const data = await response.json();
        
        if (data.sucesso) {
            // Remover linha da tabela
            const linha = document.getElementById(`participante-${id}`);
            if (linha) {
                linha.remove();
                mostrarNotificacao(data.mensagem || 'Participante excluído com sucesso!');
                
                // Verificar se a tabela ficou vazia
                const corpoTabela = document.getElementById('corpoTabela');
                if (!corpoTabela || corpoTabela.children.length === 0) {
                    location.reload();
                }
            }
        } else {
            mostrarNotificacao(data.erro || 'Erro ao excluir participante', 'danger');
        }
    } catch (error) {
        mostrarNotificacao('Erro de conexão: ' + error.message, 'danger');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // ========== ADICIONAR PARTICIPANTE (AJAX) ==========
    const formAdicionar = document.getElementById('formAdicionar');
    const btnSalvar = document.getElementById('btnSalvar');
    const spinnerSalvar = document.getElementById('spinnerSalvar');
    const modalAdicionar = document.getElementById('modalAdicionar');
    
    if (formAdicionar) {
        formAdicionar.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Desabilitar botão e mostrar spinner
            btnSalvar.disabled = true;
            spinnerSalvar.style.display = 'inline-block';
            
            const formData = new FormData(this);
            
            try {
                const response = await fetch('/api/participantes', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.sucesso) {
                    // Fechar modal
                    const modal = bootstrap.Modal.getInstance(modalAdicionar);
                    modal.hide();
                    
                    // Mostrar notificação
                    mostrarNotificacao(data.mensagem || 'Participante adicionado com sucesso!');
                    
                    // Limpar formulário
                    formAdicionar.reset();
                    
                    // Se a API retornar os dados, adicionar à tabela sem recarregar
                    if (data.participante) {
                        adicionarLinhaTabela(data.participante);
                    } else {
                        // Recarregar após 1 segundo
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    }
                    
                } else {
                    mostrarNotificacao(data.erro || 'Erro ao adicionar participante', 'danger');
                }
            } catch (error) {
                mostrarNotificacao('Erro de conexão: ' + error.message, 'danger');
            } finally {
                // Reabilitar botão e esconder spinner
                btnSalvar.disabled = false;
                spinnerSalvar.style.display = 'none';
            }
        });
    }
    
    // ========== EDITAR PARTICIPANTE ==========
    const formEditar = document.getElementById('formEditar');
    const btnAtualizar = document.getElementById('btnAtualizar');
    const spinnerAtualizar = document.getElementById('spinnerAtualizar');
    
    if (formEditar) {
        formEditar.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            btnAtualizar.disabled = true;
            spinnerAtualizar.style.display = 'inline-block';
            
            const formData = new FormData(this);
            const id = formData.get('id');
            
            try {
                const response = await fetch(`/api/participantes/atualizar/${id}`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.sucesso) {
                    // Fechar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalEditar'));
                    modal.hide();
                    
                    mostrarNotificacao('Participante atualizado com sucesso!');
                    
                    // Recarregar após 1 segundo
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    mostrarNotificacao(data.erro || 'Erro ao atualizar participante', 'danger');
                }
            } catch (error) {
                mostrarNotificacao('Erro de conexão: ' + error.message, 'danger');
            } finally {
                btnAtualizar.disabled = false;
                spinnerAtualizar.style.display = 'none';
            }
        });
    }
    
    // Atribuir eventos aos botões existentes
    reatribuirEventosBotoes();
    
    // Limpar formulário quando modal é fechado
    if (modalAdicionar) {
        modalAdicionar.addEventListener('hidden.bs.modal', function() {
            formAdicionar.reset();
        });
    }
});
</script>
{% endblock %}
[file content end]