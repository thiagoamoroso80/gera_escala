{% extends "base.html" %}

{% block content %}
<div class="container-fluid px-0">
    <!-- Cabeçalho Responsivo -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
        <div class="mb-3 mb-md-0">
            <h1 class="h3 mb-1">
                <i class="bi bi-magic me-2"></i>Gerar Nova Escala
            </h1>
            <p class="text-muted mb-0">
                Gere automaticamente as escalas para o ano selecionado
            </p>
        </div>
        
        <div class="d-flex align-items-center">
            <span class="badge bg-warning text-dark">
                <i class="bi bi-exclamation-triangle me-1"></i>
                <span class="d-none d-sm-inline">Ação Irreversível</span>
                <span class="d-inline d-sm-none">Atenção</span>
            </span>
        </div>
    </div>

    <!-- Conteúdo Principal -->
    <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-8">
            <div class="card border-warning">
                <div class="card-header bg-warning text-white">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle me-2" style="font-size: 1.5rem;"></i>
                        <h5 class="mb-0">Atenção - Ação Importante</h5>
                    </div>
                </div>
                
                <div class="card-body">
                    <!-- Alerta de Aviso -->
                    <div class="alert alert-warning border-warning mb-4">
                        <div class="d-flex">
                            <div class="me-3 flex-shrink-0">
                                <i class="bi bi-info-circle" style="font-size: 1.5rem;"></i>
                            </div>
                            <div>
                                <h6 class="alert-heading mb-2">Esta ação é <strong>irreversível</strong></h6>
                                <ul class="mb-0 ps-3">
                                    <li class="mb-1">Todas as escalas existentes para o ano selecionado serão <strong>substituídas</strong></li>
                                    <li class="mb-1">Certifique-se de que todos os grupos estão cadastrados corretamente</li>
                                    <li>A geração segue as regras automáticas do sistema</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Formulário de Geração -->
                    <form id="formGerar" method="post" action="/api/gerar">
                        <input type="hidden" name="username" value="admin">
                        <input type="hidden" name="password" value="{{ request.query_params.get('password', '') }}">
                        
                        <!-- Seleção de Ano -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-calendar me-1"></i>
                                Selecione o ano para gerar a escala
                            </label>
                            <div class="row g-2">
                                {% for ano in range(ano_atual-1, ano_atual+3) %}
                                <div class="col-6 col-sm-3">
                                    <div class="form-check card-option">
                                        <input class="form-check-input" type="radio" name="ano" 
                                               id="ano{{ ano }}" value="{{ ano }}" 
                                               {% if ano == ano_atual %}checked{% endif %}>
                                        <label class="form-check-label w-100" for="ano{{ ano }}">
                                            <div class="card text-center p-3 h-100">
                                                <div class="fs-4 fw-bold mb-1">{{ ano }}</div>
                                                <small class="text-muted">
                                                    {% if ano == ano_atual %}
                                                    <span class="text-success">Ano Atual</span>
                                                    {% elif ano < ano_atual %}
                                                    <span class="text-warning">Ano Anterior</span>
                                                    {% else %}
                                                    <span class="text-primary">Próximo Ano</span>
                                                    {% endif %}
                                                </small>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Informações Adicionais -->
                        <div class="mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="mb-3">
                                        <i class="bi bi-info-circle me-2"></i>
                                        O que será gerado?
                                    </h6>
                                    <div class="row g-3">
                                        <div class="col-6 col-md-3">
                                            <div class="text-center">
                                                <div class="text-success mb-1">
                                                    <i class="bi bi-house-door" style="font-size: 1.5rem;"></i>
                                                </div>
                                                <small class="text-muted">Defumações</small>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <div class="text-center">
                                                <div class="text-primary mb-1">
                                                    <i class="bi bi-stars" style="font-size: 1.5rem;"></i>
                                                </div>
                                                <small class="text-muted">Limpezas</small>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <div class="text-center">
                                                <div class="text-info mb-1">
                                                    <i class="bi bi-people" style="font-size: 1.5rem;"></i>
                                                </div>
                                                <small class="text-muted">Participantes</small>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <div class="text-center">
                                                <div class="text-warning mb-1">
                                                    <i class="bi bi-collection" style="font-size: 1.5rem;"></i>
                                                </div>
                                                <small class="text-muted">Grupos</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Botões de Ação -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <button type="button" class="btn btn-secondary btn-mobile-block" 
                                    onclick="window.history.back()">
                                <i class="bi bi-arrow-left me-1"></i>
                                <span class="d-none d-sm-inline">Cancelar e Voltar</span>
                                <span class="d-inline d-sm-none">Voltar</span>
                            </button>
                            
                            <button type="submit" class="btn btn-success btn-mobile-block" id="btnGerar">
                                <i class="bi bi-magic me-1"></i>
                                <span class="d-none d-sm-inline">Gerar Escala Automática</span>
                                <span class="d-inline d-sm-none">Gerar Escala</span>
                            </button>
                        </div>
                    </form>
                    
                    <!-- Resultado da Geração -->
                    <div id="resultado" class="mt-4" style="display: none;">
                        <div class="alert alert-success border-success">
                            <div class="d-flex">
                                <div class="me-3 flex-shrink-0">
                                    <i class="bi bi-check-circle" style="font-size: 1.5rem;"></i>
                                </div>
                                <div>
                                    <h6 class="alert-heading mb-2">Escala gerada com sucesso!</h6>
                                    <p id="mensagem" class="mb-3"></p>
                                    <div class="d-flex flex-column flex-sm-row gap-2">
                                        <a href="/escalas?username=admin&password={{ request.query_params.get('password', '') }}" 
                                           class="btn btn-primary btn-sm">
                                            <i class="bi bi-calendar3 me-1"></i>
                                            Ver Escalas Geradas
                                        </a>
                                        <a href="/dashboard?username=admin&password={{ request.query_params.get('password', '') }}" 
                                           class="btn btn-success btn-sm">
                                            <i class="bi bi-speedometer2 me-1"></i>
                                            Voltar ao Dashboard
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Erro na Geração -->
                    <div id="erro" class="mt-4" style="display: none;">
                        <div class="alert alert-danger border-danger">
                            <div class="d-flex">
                                <div class="me-3 flex-shrink-0">
                                    <i class="bi bi-x-circle" style="font-size: 1.5rem;"></i>
                                </div>
                                <div>
                                    <h6 class="alert-heading mb-2">Erro ao gerar escala</h6>
                                    <p id="erroMensagem" class="mb-0"></p>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <button type="button" class="btn btn-warning btn-sm" onclick="reloadForm()">
                                <i class="bi bi-arrow-clockwise me-1"></i>
                                Tentar Novamente
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Rodapé com Dicas -->
                <div class="card-footer bg-light">
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <div class="d-flex align-items-center">
                                <div class="me-2">
                                    <i class="bi bi-lightbulb text-warning"></i>
                                </div>
                                <div>
                                    <small class="text-muted">
                                        <strong>Dica:</strong> Verifique os grupos antes de gerar
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="d-flex align-items-center">
                                <div class="me-2">
                                    <i class="bi bi-clock text-info"></i>
                                </div>
                                <div>
                                    <small class="text-muted">
                                        <strong>Tempo:</strong> Processo leva alguns segundos
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dica para Mobile -->
    <div class="d-md-none mt-4">
        <div class="alert alert-light border">
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <i class="bi bi-phone text-primary" style="font-size: 1.5rem;"></i>
                </div>
                <div>
                    <small class="text-muted">
                        <strong>Importante:</strong> Esta ação substitui todas as escalas do ano selecionado. 
                        Certifique-se antes de prosseguir.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CSS Adicional para Responsividade -->
<style>
    /* Botões responsivos */
    .btn-mobile-block {
        width: 100%;
    }
    
    @media (min-width: 768px) {
        .btn-mobile-block {
            width: auto;
        }
    }
    
    /* Opções de ano como cards */
    .card-option .card {
        border: 2px solid #dee2e6;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .card-option .form-check-input:checked + label .card {
        border-color: #28a745;
        background-color: rgba(40, 167, 69, 0.05);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .card-option .form-check-input {
        display: none;
    }
    
    /* Alerts responsivos */
    .alert .d-flex {
        flex-direction: column;
        text-align: center;
    }
    
    @media (min-width: 576px) {
        .alert .d-flex {
            flex-direction: row;
            text-align: left;
        }
    }
    
    /* Ajustes para mobile */
    @media (max-width: 767.98px) {
        .card-header h5 {
            font-size: 1.1rem;
        }
        
        .alert-heading {
            font-size: 1rem;
        }
        
        .card-option .card {
            padding: 15px 10px;
        }
        
        .card-option .card .fs-4 {
            font-size: 1.3rem !important;
        }
    }
    
    @media (max-width: 575.98px) {
        .card-body {
            padding: 1rem !important;
        }
        
        .alert {
            padding: 12px 15px;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 0.875rem;
        }
        
        /* Grid de anos 2x2 em mobile */
        .row.g-2 .col-6 {
            padding: 5px;
        }
    }
    
    /* Animações */
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .generating {
        animation: pulse 1s infinite;
    }
    
    /* Progresso da geração */
    .progress-container {
        display: none;
        margin: 20px 0;
    }
    
    .progress-container.show {
        display: block;
    }
    
    /* Ajustes para telas muito pequenas */
    @media (max-width: 360px) {
        .card-header {
            padding: 12px;
        }
        
        .card-body {
            padding: 12px !important;
        }
        
        .btn-mobile-block span {
            font-size: 0.9rem;
        }
        
        .card-option .card {
            padding: 12px 8px;
        }
        
        .card-option .card .fs-4 {
            font-size: 1.2rem !important;
        }
    }
    
    /* Estados de botão */
    #btnGerar:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }
    
    /* Feedback visual para seleção */
    .card-option .card:hover {
        border-color: #adb5bd;
        background-color: #f8f9fa;
    }
</style>

<!-- JavaScript para funcionalidades -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('formGerar');
        const btnGerar = document.getElementById('btnGerar');
        const resultado = document.getElementById('resultado');
        const erro = document.getElementById('erro');
        
        // Criar container de progresso
        const progressContainer = document.createElement('div');
        progressContainer.className = 'progress-container';
        progressContainer.innerHTML = `
            <div class="text-center mb-2">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Gerando...</span>
                </div>
                <p class="mt-2 text-muted">Gerando escala, por favor aguarde...</p>
            </div>
            <div class="progress">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 0%"></div>
            </div>
        `;
        form.parentNode.insertBefore(progressContainer, form.nextSibling);
        
        // Simular progresso
        function simulateProgress() {
            const progressBar = document.querySelector('.progress-bar');
            let width = 0;
            const interval = setInterval(() => {
                if (width >= 100) {
                    clearInterval(interval);
                } else {
                    width += 10;
                    progressBar.style.width = width + '%';
                }
            }, 300);
        }
        
        // Envio do formulário
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Desabilitar botão
            btnGerar.disabled = true;
            btnGerar.innerHTML = `
                <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                <span class="d-none d-sm-inline">Gerando Escala...</span>
                <span class="d-inline d-sm-none">Gerando...</span>
            `;
            
            // Mostrar progresso
            progressContainer.classList.add('show');
            simulateProgress();
            
            // Esconder resultados anteriores
            resultado.style.display = 'none';
            erro.style.display = 'none';
            
            const formData = new FormData(form);
            
            try {
                const response = await fetch('/api/gerar', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                // Esconder progresso
                progressContainer.classList.remove('show');
                
                if (data.sucesso) {
                    // Mostrar resultado
                    document.getElementById('mensagem').textContent = 
                        `Foram geradas ${data.defumacoes || 0} defumações e ${data.limpezas || 0} limpezas para o ano ${data.ano}.`;
                    resultado.style.display = 'block';
                    erro.style.display = 'none';
                    form.style.display = 'none';
                    
                    // Scroll para resultado
                    resultado.scrollIntoView({ behavior: 'smooth' });
                } else {
                    // Mostrar erro
                    document.getElementById('erroMensagem').textContent = 
                        data.erro || 'Ocorreu um erro desconhecido ao gerar a escala.';
                    resultado.style.display = 'none';
                    erro.style.display = 'block';
                    
                    // Reabilitar botão
                    btnGerar.disabled = false;
                    btnGerar.innerHTML = `
                        <i class="bi bi-magic me-1"></i>
                        <span class="d-none d-sm-inline">Gerar Escala Automática</span>
                        <span class="d-inline d-sm-none">Gerar Escala</span>
                    `;
                    
                    // Scroll para erro
                    erro.scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                // Esconder progresso
                progressContainer.classList.remove('show');
                
                // Mostrar erro de conexão
                document.getElementById('erroMensagem').textContent = 
                    'Erro de conexão: ' + error.message + '. Verifique sua internet e tente novamente.';
                resultado.style.display = 'none';
                erro.style.display = 'block';
                
                // Reabilitar botão
                btnGerar.disabled = false;
                btnGerar.innerHTML = `
                    <i class="bi bi-magic me-1"></i>
                    <span class="d-none d-sm-inline">Gerar Escala Automática</span>
                    <span class="d-inline d-sm-none">Gerar Escala</span>
                `;
                
                // Scroll para erro
                erro.scrollIntoView({ behavior: 'smooth' });
            }
        });
        
        // Confirmar antes de enviar (mobile)
        if (window.innerWidth < 768) {
            form.addEventListener('submit', function(e) {
                if (!confirm('ATENÇÃO: Esta ação substituirá TODAS as escalas do ano selecionado.\n\nTem certeza que deseja continuar?')) {
                    e.preventDefault();
                    
                    // Reabilitar botão se cancelado
                    btnGerar.disabled = false;
                    btnGerar.innerHTML = `
                        <i class="bi bi-magic me-1"></i>
                        <span class="d-none d-sm-inline">Gerar Escala Automática</span>
                        <span class="d-inline d-sm-none">Gerar Escala</span>
                    `;
                    
                    // Esconder progresso
                    progressContainer.classList.remove('show');
                }
            });
        }
        
        // Feedback visual para seleção de ano
        document.querySelectorAll('.card-option .card').forEach(card => {
            card.addEventListener('click', function() {
                // Remover seleção anterior
                document.querySelectorAll('.card-option .card').forEach(c => {
                    c.style.borderColor = '#dee2e6';
                    c.style.backgroundColor = '';
                });
                
                // Selecionar atual
                this.style.borderColor = '#28a745';
                this.style.backgroundColor = 'rgba(40, 167, 69, 0.05)';
                
                // Marcar radio button correspondente
                const radioId = this.closest('label').getAttribute('for');
                document.getElementById(radioId).checked = true;
            });
        });
        
        // Função para recarregar formulário
        window.reloadForm = function() {
            form.style.display = 'block';
            resultado.style.display = 'none';
            erro.style.display = 'none';
            
            // Reabilitar botão
            btnGerar.disabled = false;
            btnGerar.innerHTML = `
                <i class="bi bi-magic me-1"></i>
                <span class="d-none d-sm-inline">Gerar Escala Automática</span>
                <span class="d-inline d-sm-none">Gerar Escala</span>
            `;
            
            // Scroll para formulário
            form.scrollIntoView({ behavior: 'smooth' });
        };
        
        // Prevenir envio duplo
        let isSubmitting = false;
        form.addEventListener('submit', function(e) {
            if (isSubmitting) {
                e.preventDefault();
                return;
            }
            isSubmitting = true;
            
            // Reset após 10 segundos (caso haja timeout)
            setTimeout(() => {
                isSubmitting = false;
                btnGerar.disabled = false;
                btnGerar.innerHTML = `
                    <i class="bi bi-magic me-1"></i>
                    <span class="d-none d-sm-inline">Gerar Escala Automática</span>
                    <span class="d-inline d-sm-none">Gerar Escala</span>
                `;
                progressContainer.classList.remove('show');
            }, 10000);
        });
        
        // Ajustar para diferentes tamanhos de tela
        function adjustForScreenSize() {
            if (window.innerWidth < 400) {
                // Telas muito pequenas
                document.body.classList.add('narrow-screen');
                
                // Ajustar cards de ano
                document.querySelectorAll('.card-option .card').forEach(card => {
                    card.style.padding = '10px 5px';
                });
                
                // Ajustar fontes
                document.querySelectorAll('.card-option .card .fs-4').forEach(el => {
                    el.style.fontSize = '1.1rem';
                });
            } else {
                document.body.classList.remove('narrow-screen');
                
                // Restaurar cards
                document.querySelectorAll('.card-option .card').forEach(card => {
                    card.style.padding = '';
                });
                
                // Restaurar fontes
                document.querySelectorAll('.card-option .card .fs-4').forEach(el => {
                    el.style.fontSize = '';
                });
            }
        }
        
        adjustForScreenSize();
        window.addEventListener('resize', adjustForScreenSize);
    });
</script>
{% endblock %}